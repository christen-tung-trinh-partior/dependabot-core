# frozen_string_literal: true

require "spec_helper"
require "dependabot/dependency"
require "dependabot/security_advisory"
require "dependabot/npm_and_yarn/native_helpers"
require "dependabot/npm_and_yarn/update_checker/vulnerability_auditor"

RSpec.describe Dependabot::NpmAndYarn::UpdateChecker::VulnerabilityAuditor do
  let(:dependency_files) { [] } # Specified in scenarios below.
  let(:credentials) do
    [{
      "type" => "git_source",
      "host" => "github.com",
      "username" => "x-access-token",
      "password" => "token"
    }]
  end

  subject do
    described_class.new(dependency_files: dependency_files, credentials: credentials)
  end

  describe "#audit" do
    let(:dependency) do
      Dependabot::Dependency.new(
        name: "@dependabot-fixtures/npm-transitive-dependency",
        version: "1.0.0",
        requirements: [{
          file: "package-lock.json",
          requirement: "1.0.0",
          groups: ["dependencies"],
          source: nil
        }],
        package_manager: "npm_and_yarn"
      )
    end

    context "when a fix is available" do
      let(:dependency_files) { project_dependency_files("npm8/locked_transitive_dependency") }

      it "returns a hash with the target version and transitive updates to make" do
        security_advisories = [
          Dependabot::SecurityAdvisory.new(
            dependency_name: dependency.name,
            package_manager: "npm_and_yarn",
            vulnerable_versions: ["<1.0.1"],
            safe_versions: ["1.0.1"]
          )
        ]

        expect(subject.audit(dependency: dependency, security_advisories: security_advisories)).
          to include(
            "dependency_name" => dependency.name,
            "current_version" => "1.0.0",
            "target_version" => "1.0.1",
            "fix_available" => true,
            "fix_updates" => [{
              "dependency_name" => "@dependabot-fixtures/npm-parent-dependency",
              "current_version" => "2.0.0",
              "target_version" => "2.0.2"
            }]
          )
      end
    end

    context "when a fix removes the vulnerable dependency" do
      let(:dependency_files) { project_dependency_files("npm8/locked_transitive_dependency_removed") }

      it "returns fix_available => false" do
        security_advisories = [
          Dependabot::SecurityAdvisory.new(
            dependency_name: dependency.name,
            package_manager: "npm_and_yarn",
            vulnerable_versions: ["<1.0.1"],
            safe_versions: ["1.0.1"]
          )
        ]

        expect(subject.audit(dependency: dependency, security_advisories: security_advisories)).
          to include("fix_available" => false)
      end
    end

    context "when a fix doesn't resolve the vulnerability" do
      let(:dependency_files) { project_dependency_files("npm8/locked_transitive_dependency") }

      it "returns fix_available => false" do
        security_advisories = [
          Dependabot::SecurityAdvisory.new(
            dependency_name: dependency.name,
            package_manager: "npm_and_yarn",
            vulnerable_versions: ["<1.0.1"],
            safe_versions: ["1.0.1"]
          )
        ]

        allow(Dependabot::SharedHelpers).
          to receive(:run_helper_subprocess).
          and_return({
            "fix_available" => true,
            "target_version" => "1.0.0"
          })

        expect(subject.audit(dependency: dependency, security_advisories: security_advisories)).
          to include("fix_available" => false)
      end
    end

    context "when a fix would downgrade a dependency" do
      let(:dependency_files) { project_dependency_files("npm8/locked_transitive_dependency") }

      it "returns fix_available => false" do
        security_advisories = [
          Dependabot::SecurityAdvisory.new(
            dependency_name: dependency.name,
            package_manager: "npm_and_yarn",
            vulnerable_versions: ["<1.0.1"],
            safe_versions: ["1.0.1"]
          )
        ]

        allow(Dependabot::SharedHelpers).
          to receive(:run_helper_subprocess).
          and_return({
            "dependency_name" => dependency.name,
            "fix_available" => true,
            "current_version" => "1.0.0",
            "target_version" => "1.0.1",
            "fix_updates" => [{
              "dependency_name" => "@dependabot-fixtures/npm-parent-dependency",
              "current_version" => "2.0.0",
              "target_version" => "1.0.2"
            }]
          })

        expect(subject.audit(dependency: dependency, security_advisories: security_advisories)).
          to include("fix_available" => false)
      end
    end

    context "in a project with no lockfile" do
      let(:dependency_files) { project_dependency_files("npm6/no_lockfile") }

      it "returns fix_available => false" do
        expect(subject.audit(dependency: dependency, security_advisories: [])).
          to include("fix_available" => false)
      end
    end

    context "when the native helper raises" do
      let(:dependency_files) { project_dependency_files("npm8/simple") }

      it "returns fix_available => false and logs the failure" do
        # Stub native helper path with the `false` builtin in order to get a
        # non-zero exit status from the helper subprocess and cause
        # `Dependabot::SharedHelpers::HelperSubprocessFailed` to be raised.
        allow(Dependabot::NpmAndYarn::NativeHelpers).
          to receive(:helper_path).and_return("false")

        expect(Dependabot.logger).to receive(:info).with(/failed/i)
        expect(subject.audit(dependency: dependency, security_advisories: [])).
          to include("fix_available" => false)
      end
    end

    context "when the native helper detects a vuln effects cycle" do
      let(:dependency_files) { project_dependency_files("npm8/transitive_dependency_effects_cycle") }

      it "returns fix_available => false and logs the error raised by the helper" do
        security_advisories = [
          Dependabot::SecurityAdvisory.new(
            dependency_name: dependency.name,
            package_manager: "npm_and_yarn",
            vulnerable_versions: ["<1.0.1"],
            safe_versions: ["1.0.1"]
          )
        ]

        expect(Dependabot.logger).to receive(:info).with(/cycle detected/i)
        expect(subject.audit(dependency: dependency, security_advisories: security_advisories)).
          to include("fix_available" => false)
      end
    end
  end
end

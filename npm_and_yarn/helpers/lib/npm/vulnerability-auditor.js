/* Vulnerability auditor for npm
 *
 * Inputs:
 *  - directory containing a package.json and a yarn.lock
 *  - security advisories to audit for
 *
 * Outputs:
 *  - A report of vulnerable dependencies
 */

const Arborist = require("@npmcli/arborist");
const nock = require('nock')

async function findVulnerableDependencies(directory, advisories) {
  const arb = new Arborist({
    path: directory,
    auditRegistry: 'http://localhost:9999'
  });

  const scope = nock('http://localhost:9999')
    .post("/-/npm/v1/security/advisories/bulk")
    .reply(200, convertAdvisoriesToRegistryBulkFormat(advisories))

  if (!nock.isActive()) {
    nock.activate()
  }

  return await arb.audit().then(report => {
    // TODO: any adjustments to output?
    return report
  }).finally(() => {
    // TODO: is this correct cleanup?
    nock.cleanAll()
    nock.restore()
  })
}

function convertAdvisoriesToRegistryBulkFormat(advisories) {
  // TODO: build from advisories
  return {
    "node-forge": [
      {
        "id": 0,
        "url": "https://github.com/advisories/stub-advisory",
        "title": "Stub Title",
        "severity": "critical",
        "vulnerable_versions": "< 1.3.0",
        "cwe": [
          "CWE-00000"
        ],
        "cvss": {
          "score": 9.8,
          "vectorString": "CV1SS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
        }
      }
    ]
  }
}

module.exports = { findVulnerableDependencies };
